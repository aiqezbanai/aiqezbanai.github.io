<!DOCTYPE html>
<html lang="hy">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Device List Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'primary': '#1a202c',
              'secondary': '#2d3748',
              'accent': '#4a5568',
              'highlight': '#38b2ac',
              'text-primary': '#e2e8f0',
              'text-secondary': '#a0aec0',
            },
          },
        },
      }
    </script>
    <style>
        /* Custom scrollbar for webkit browsers */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* secondary color */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4a5568; /* accent color */
            border-radius: 4px;
            border: 2px solid #2d3748; /* secondary color */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #38b2ac; /* highlight color */
        }
        /* For Firefox */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #4a5568 #2d3748;
        }
        /* Disabled button styles */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1);
        }
        /* Active Tab Style */
        .tab-active {
            border-color: #38b2ac; /* highlight color */
            color: #e2e8f0; /* text-primary color */
            background-color: #4a5568; /* accent color */
        }
        /* Utility class to hide file input */
        .hidden-file-input {
            width: 0.1px;
            height: 0.1px;
            opacity: 0;
            overflow: hidden;
            position: absolute;
            z-index: -1;
        }
    </style>
</head>
<body class="bg-primary text-text-primary font-sans">
    
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-text-primary">
                    Device List Manager
                </h1>
            </div>
        </header>

        <nav class="mb-6 border-b border-accent">
            <div class="flex flex-wrap gap-2 sm:gap-4 -mb-px">
                <button data-tab="printers" class="tab-button py-2 px-4 text-sm sm:text-base font-medium border-b-2 border-transparent text-text-secondary hover:text-text-primary hover:border-highlight transition-colors duration-200">Printers</button>
                <button data-tab="ipphones" class="tab-button py-2 px-4 text-sm sm:text-base font-medium border-b-2 border-transparent text-text-secondary hover:text-text-primary hover:border-highlight transition-colors duration-200">IP Phones</button>
                <button data-tab="computers" class="tab-button py-2 px-4 text-sm sm:text-base font-medium border-b-2 border-transparent text-text-secondary hover:text-text-primary hover:border-highlight transition-colors duration-200">Computers</button>
                <button data-tab="users" class="tab-button py-2 px-4 text-sm sm:text-base font-medium border-b-2 border-transparent text-text-secondary hover:text-text-primary hover:border-highlight transition-colors duration-200">Users</button>
                <button data-tab="switches" class="tab-button py-2 px-4 text-sm sm:text-base font-medium border-b-2 border-transparent text-text-secondary hover:text-text-primary hover:border-highlight transition-colors duration-200">Switches</button>
            </div>
        </nav>

        <div class="w-full flex flex-col md:flex-row items-center justify-between gap-4 mb-6">
            <div class="relative w-full md:w-64 order-2 md:order-1">
                <input
                  id="search-input"
                  type="text"
                  placeholder="Որոնում..."
                  class="w-full bg-secondary border border-accent rounded-lg py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-highlight text-text-primary placeholder-text-secondary"
                />
                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="h-5 w-5 text-text-secondary"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                </div>
            </div>
            <div class="w-full md:w-auto flex flex-wrap justify-end gap-4 order-1 md:order-2">
                <input type="file" id="import-file-input" accept=".csv" class="hidden-file-input">
                <label for="import-file-input" id="import-button" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105 cursor-pointer">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 13.5L12 21m0 0l-7.5-7.5M12 21V3" /></svg>
                    <span>Import CSV</span>
                </label>
                <button id="export-button" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" /></svg>
                    <span>Export CSV</span>
                </button>
                <button id="add-button" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-highlight hover:bg-teal-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg>
                    <span>Ավելացնել</span>
                </button>
                <button id="delete-all-button" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.124-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.077-2.09.921-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path></svg>
                    <span>Ջնջել բոլորը</span>
                </button>
            </div>
        </div>

        <main>
            <div id="no-records-message" class="hidden text-center py-16 bg-secondary rounded-lg">
                <h2 class="text-xl text-text-secondary">Գրառումներ չկան</h2>
                <p class="mt-2 text-text-secondary">Սեղմեք "Ավելացնել"՝ նոր սարք/գրառում ավելացնելու համար:</p>
            </div>
            <div id="table-container" class="bg-secondary shadow-lg rounded-lg overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="min-w-full leading-normal">
                        <thead id="device-table-header">
                            </thead>
                        <tbody id="device-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
        
        <footer id="pagination-container" class="hidden mt-6 flex justify-center items-center gap-4">
            <button id="prev-page-button" class="py-2 px-4 bg-accent hover:bg-gray-600 text-text-primary font-semibold rounded-lg transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                Նախորդ
            </button>
            <span id="page-info" class="text-text-secondary font-medium"></span>
            <button id="next-page-button" class="py-2 px-4 bg-accent hover:bg-gray-600 text-text-primary font-semibold rounded-lg transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                Հաջորդ
            </button>
        </footer>

    </div>

    <div id="form-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div class="bg-secondary rounded-lg shadow-xl w-full max-w-lg max-h-full overflow-y-auto custom-scrollbar">
            <div class="p-6">
                <h2 id="form-modal-title" class="text-2xl font-bold mb-6 text-text-primary"></h2>
                <form id="device-form" class="space-y-4">
                    <input type="hidden" id="record-id" name="id">
                    <div id="form-fields-container">
                        </div>
                    <div class="flex justify-end gap-4 pt-6">
                        <button type="button" id="form-cancel-button" class="py-2 px-4 bg-accent hover:bg-gray-600 text-text-primary font-semibold rounded-lg transition-colors duration-300">Չեղարկել</button>
                        <button type="submit" id="form-submit-button" class="py-2 px-4 bg-highlight hover:bg-teal-500 text-white font-semibold rounded-lg transition-colors duration-300"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div class="bg-secondary rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6">
                <h2 class="text-xl font-bold mb-4 text-text-primary">Ջնջումը հաստատել</h2>
                <p class="text-text-secondary mb-4">Վստա՞հ եք, որ ցանկանում եք ջնջել: Մուտքագրեք գաղտնաբառը՝ հաստատելու համար։</p>
                <input type="password" id="delete-password-input" class="w-full bg-primary border border-accent rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-highlight text-text-primary mb-6" placeholder="Գաղտնաբառ">
                <div class="flex justify-end gap-4">
                    <button id="confirm-cancel-button" class="py-2 px-4 bg-accent hover:bg-gray-600 text-text-primary font-semibold rounded-lg transition-colors duration-300">Չեղարկել</button>
                    <button id="confirm-delete-button" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors duration-300" disabled>Ջնջել</button>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-all-confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div class="bg-secondary rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6">
                <h2 class="text-xl font-bold mb-4 text-text-primary">Բոլորը ջնջել</h2>
                <p class="text-text-secondary mb-4">Վստա՞հ եք, որ ցանկանում եք ջնջել **բոլոր** գրառումները: Այս գործողությունը անդառնալի է։ Մուտքագրեք գաղտնաբառը։</p>
                <input type="password" id="delete-all-password-input" class="w-full bg-primary border border-accent rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-highlight text-text-primary mb-6" placeholder="Գաղտնաբառ">
                <div class="flex justify-end gap-4">
                    <button id="confirm-all-cancel-button" class="py-2 px-4 bg-accent hover:bg-gray-600 text-text-primary font-semibold rounded-lg transition-colors duration-300">Չեղարկել</button>
                    <button id="confirm-all-delete-button" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors duration-300" disabled>Այո, ջնջել</button>
                </div>
            </div>
        </div>
    </div>

    <div id="validation-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div class="bg-secondary rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6 text-center">
                <h2 id="validation-modal-title" class="text-xl font-bold mb-4 text-text-primary"></h2>
                <p id="validation-message" class="text-text-secondary mb-6"></p>
                <div class="flex justify-center gap-4">
                    <button id="validation-close-button" class="py-2 px-6 bg-highlight hover:bg-teal-500 text-white font-semibold rounded-lg transition-colors duration-300">Փակել</button>
                </div>
            </div>
        </div>
    </div>

    <div id="copy-toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-highlight text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transform translate-y-4 transition-all duration-300 ease-in-out z-50 pointer-events-none">
        Պատճենվել է!
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // Configuration for each device type
    const DEVICE_CONFIG = {
        printers: {
            title: 'Տպիչներ',
            storageKey: 'deviceRecords_printers',
            fields: [
                { id: 'printerName', label: 'Printer Name', required: true },
                { id: 'ipAddress', label: 'IP Address', required: true },
                { id: 'location', label: 'Location', required: false },
                { id: 'model', label: 'Model', required: false },
                { id: 'serialNumber', label: 'Serial Number', required: false },
                { id: 'notes', label: 'Նշումներ', type: 'textarea', required: false },
            ]
        },
        ipphones: {
            title: 'IP Հեռախոսներ',
            storageKey: 'deviceRecords_ipphones',
            fields: [
                { id: 'extension', label: 'Extension', required: true },
                { id: 'ipAddress', label: 'IP Address', required: true },
                { id: 'user', label: 'User/Employee', required: false },
                { id: 'location', label: 'Location', required: false },
                { id: 'model', label: 'Model', required: false },
                { id: 'notes', label: 'Նշումներ', type: 'textarea', required: false },
            ]
        },
        computers: {
            title: 'Համակարգիչներ',
            storageKey: 'deviceRecords_computers',
            fields: [
                { id: 'deviceName', label: 'Device Name', required: true },
                { id: 'ipAddress', label: 'IP Address', required: true },
                { id: 'user', label: 'User/Employee', required: false },
                { id: 'department', label: 'Department', required: false },
                { id: 'serialNumber', label: 'Serial Number', required: false },
                { id: 'notes', label: 'Նշումներ', type: 'textarea', required: false },
            ]
        },
        users: {
            title: 'Օգտատերեր',
            storageKey: 'deviceRecords_users',
            fields: [
                { id: 'employeeID', label: 'Employee ID', required: true },
                { id: 'fullName', label: 'Full Name', required: true },
                { id: 'department', label: 'Department', required: false },
                { id: 'email', label: 'Email', required: false },
                { id: 'phone', label: 'Phone Number', required: false },
                { id: 'notes', label: 'Նշումներ', type: 'textarea', required: false },
            ]
        },
        switches: {
            title: 'Սվիչներ',
            storageKey: 'deviceRecords_switches',
            fields: [
                { id: 'deviceName', label: 'Device Name', required: true },
                { id: 'ipAddress', label: 'IP Address', required: true },
                { id: 'location', label: 'Location/Rack', required: false },
                { id: 'model', label: 'Model', required: false },
                { id: 'ports', label: 'Total Ports', required: false },
                { id: 'notes', label: 'Նշումներ', type: 'textarea', required: false },
            ]
        }
    };

    const DELETE_PASSWORD = 'Delete'; // The required password for deletion

    // State
    let allRecords = {}; // Stores all records for all tabs
    let currentTab = 'printers';
    let editingRecordId = null;
    let deletingRecordId = null;
    let copyToastTimeout = null;
    let currentPage = 1;
    const recordsPerPage = 10;

    // DOM Elements
    const tabButtons = document.querySelectorAll('.tab-button');
    const tableHeader = document.getElementById('device-table-header');
    const tableBody = document.getElementById('device-table-body');
    const noRecordsMessage = document.getElementById('no-records-message');
    const tableContainer = document.getElementById('table-container');
    const searchInput = document.getElementById('search-input');
    const copyToast = document.getElementById('copy-toast');
    
    // Pagination Elements
    const paginationContainer = document.getElementById('pagination-container');
    const prevPageButton = document.getElementById('prev-page-button');
    const nextPageButton = document.getElementById('next-page-button');
    const pageInfo = document.getElementById('page-info');

    // Modals
    const formModal = document.getElementById('form-modal');
    const confirmationModal = document.getElementById('confirmation-modal');
    const validationModal = document.getElementById('validation-modal');
    const deleteAllConfirmationModal = document.getElementById('delete-all-confirmation-modal');
    
    // Delete Confirmation Elements
    const deletePasswordInput = document.getElementById('delete-password-input');
    const confirmDeleteButton = document.getElementById('confirm-delete-button');
    const deleteAllPasswordInput = document.getElementById('delete-all-password-input');
    const confirmAllDeleteButton = document.getElementById('confirm-all-delete-button');

    // Form Elements
    const deviceForm = document.getElementById('device-form');
    const formModalTitle = document.getElementById('form-modal-title');
    const formSubmitButton = document.getElementById('form-submit-button');
    const formFieldsContainer = document.getElementById('form-fields-container');

    // Buttons
    const addButton = document.getElementById('add-button');
    const deleteAllButton = document.getElementById('delete-all-button');
    const formCancelButton = document.getElementById('form-cancel-button');
    const confirmCancelButton = document.getElementById('confirm-cancel-button');
    const validationCloseButton = document.getElementById('validation-close-button');
    const confirmAllCancelButton = document.getElementById('confirm-all-cancel-button');
    
    // Export/Import Elements
    const exportButton = document.getElementById('export-button');
    const importFileInput = document.getElementById('import-file-input');
    const validationModalTitle = document.getElementById('validation-modal-title');


    // --- Data Persistence ---
    const loadRecords = () => {
        for (const key in DEVICE_CONFIG) {
            try {
                const savedRecords = localStorage.getItem(DEVICE_CONFIG[key].storageKey);
                let records = savedRecords ? JSON.parse(savedRecords) : [];
                
                // Ensure all records have an ID
                let madeChanges = false;
                records.forEach(record => {
                    if (!record.id) {
                        record.id = crypto.randomUUID(); 
                        madeChanges = true;
                    }
                });
                
                allRecords[key] = records;
                
                if (madeChanges) {
                    saveRecords(key);
                }
            } catch (error) {
                console.error(`Failed to parse ${key} records from localStorage`, error);
                allRecords[key] = [];
            }
        }
    };

    const saveRecords = (deviceType) => {
        try {
            localStorage.setItem(DEVICE_CONFIG[deviceType].storageKey, JSON.stringify(allRecords[deviceType]));
        } catch (error) {
            console.error(`Failed to save ${deviceType} records to localStorage`, error);
        }
    };
    
    // --- Pagination ---
    const renderPagination = (totalRecords) => {
        const totalPages = Math.ceil(totalRecords / recordsPerPage);

        if (totalPages <= 1) {
            paginationContainer.classList.add('hidden');
            return;
        }

        paginationContainer.classList.remove('hidden');
        pageInfo.textContent = `Էջ ${currentPage} / ${totalPages}`;
        prevPageButton.disabled = currentPage === 1;
        nextPageButton.disabled = currentPage === totalPages;
    };


    // --- Rendering ---
    const getFilteredRecords = () => {
        const currentRecords = allRecords[currentTab] || [];
        const searchTerm = searchInput.value.toLowerCase();
        
        return currentRecords.filter(record =>
            Object.values(record).some(value => 
                value && String(value).toLowerCase().includes(searchTerm)
            )
        );
    };

    const renderHeader = () => {
        const config = DEVICE_CONFIG[currentTab];
        const headers = config.fields.map(field => field.label);
        
        const headerRow = document.createElement('tr');
        headerRow.className = 'border-b-2 border-accent bg-accent text-left text-xs font-semibold text-text-secondary uppercase tracking-wider';
        
        let html = '<th class="px-5 py-3">No.</th>';
        headers.forEach(header => {
            html += `<th class="px-5 py-3">${header}</th>`;
        });
        html += '<th class="px-5 py-3 text-center">Գործողություն</th>';
        
        tableHeader.innerHTML = html;
    };

    const renderTable = () => {
        const filteredRecords = getFilteredRecords();
        const totalRecords = filteredRecords.length;
        const totalPages = Math.ceil(totalRecords / recordsPerPage);
        
        // Adjust current page if it's out of bounds
        if (currentPage > totalPages) {
            currentPage = totalPages || 1;
        }

        const startIndex = (currentPage - 1) * recordsPerPage;
        const endIndex = startIndex + recordsPerPage;
        const paginatedRecords = filteredRecords.slice(startIndex, endIndex);

        // Update action buttons based on current record count
        const hasRecords = allRecords[currentTab].length > 0;
        deleteAllButton.disabled = !hasRecords;

        renderHeader();
        tableBody.innerHTML = '';

        if (totalRecords === 0) {
            noRecordsMessage.classList.remove('hidden');
            tableContainer.classList.add('hidden');
        } else {
            noRecordsMessage.classList.add('hidden');
            tableContainer.classList.remove('hidden');
            
            const config = DEVICE_CONFIG[currentTab];
            const fieldKeys = config.fields.map(f => f.id);

            paginatedRecords.forEach((record, index) => {
                const globalIndex = startIndex + index;
                const row = document.createElement('tr');
                row.className = 'border-b border-accent hover:bg-accent/50 transition-colors duration-200';
                row.dataset.id = record.id;

                const createCopyableCell = (text) => {
                    const cell = document.createElement('td');
                    cell.className = 'px-5 py-4 text-sm max-w-xs';
                    
                    const container = document.createElement('div');
                    container.className = 'flex items-center gap-2 group relative';
                    
                    const textSpan = document.createElement('span');
                    textSpan.className = 'truncate';
                    textSpan.title = text;
                    textSpan.textContent = text || "-";
                    
                    const copyButton = document.createElement('button');
                    copyButton.className = 'opacity-0 group-hover:opacity-100 text-text-secondary hover:text-highlight transition-all duration-200 focus:outline-none';
                    copyButton.title = 'Պատճենել';
                    copyButton.disabled = !text;
                    copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="h-4 w-4"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>`;
                    
                    copyButton.onclick = (e) => {
                        e.stopPropagation(); // Stop event propagation to prevent action on row from triggering
                        navigator.clipboard.writeText(text).then(() => {
                            if (copyToastTimeout) {
                                clearTimeout(copyToastTimeout);
                            }
                            copyToast.classList.remove('opacity-0', 'translate-y-4');
                            copyToast.classList.add('opacity-100', 'translate-y-0');
                            copyToastTimeout = setTimeout(() => {
                                copyToast.classList.remove('opacity-100', 'translate-y-0');
                                copyToast.classList.add('opacity-0', 'translate-y-4');
                                copyToastTimeout = null;
                            }, 2000);
                        }).catch(err => console.error("Failed to copy text: ", err));
                    };

                    container.appendChild(textSpan);
                    if (text) {
                        container.appendChild(copyButton);
                    }
                    cell.appendChild(container);
                    return cell;
                };
                
                row.innerHTML = `<td class="px-5 py-4 text-sm">${globalIndex + 1}</td>`;
                
                fieldKeys.forEach(key => {
                    row.appendChild(createCopyableCell(record[key]));
                });

                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-5 py-4 text-sm text-center';
                actionsCell.innerHTML = `
                    <div class="flex items-center justify-center gap-4">
                        <button data-action="duplicate" class="text-green-400 hover:text-green-300 transition-colors duration-200 focus:outline-none" title="Կրկնօրինակել">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg>
                        </button>
                        <button data-action="edit" class="text-blue-400 hover:text-blue-300 transition-colors duration-200 focus:outline-none" title="Խմբագրել">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                        </button>
                        <button data-action="delete" class="text-red-400 hover:text-red-300 transition-colors duration-200 focus:outline-none" title="Ջնջել">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>`;
                row.appendChild(actionsCell);
                tableBody.appendChild(row);
            });
        }
        renderPagination(totalRecords);
    };
    
    // --- Form Rendering ---
    const renderFormFields = (config) => {
        formFieldsContainer.innerHTML = '';
        config.fields.forEach(field => {
            const labelText = field.label + (field.required ? ' *' : '');
            let inputElement;

            if (field.type === 'textarea') {
                inputElement = `<textarea id="${field.id}" name="${field.id}" rows="3" class="w-full bg-primary border border-accent rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-highlight text-text-primary"></textarea>`;
            } else {
                inputElement = `<input type="text" id="${field.id}" name="${field.id}" class="w-full bg-primary border border-accent rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-highlight text-text-primary">`;
            }

            const fieldDiv = document.createElement('div');
            fieldDiv.innerHTML = `
                <label for="${field.id}" class="block text-sm font-medium text-text-secondary mb-1">${labelText}</label>
                ${inputElement}
            `;
            formFieldsContainer.appendChild(fieldDiv);
        });
    };

    // --- Tab Control ---
    const switchTab = (newTab) => {
        if (currentTab === newTab) return;
        currentTab = newTab;
        currentPage = 1;
        
        tabButtons.forEach(btn => {
            btn.classList.remove('tab-active');
            if (btn.dataset.tab === newTab) {
                btn.classList.add('tab-active');
            }
        });
        
        renderTable();
    };

    // --- Modal Control ---
    const openModal = (modal, title = 'Ուշադրություն') => {
        if (modal === validationModal) {
            validationModalTitle.textContent = title;
        }
        modal.classList.remove('hidden');
    };
    const closeModal = (modal) => modal.classList.add('hidden');
    const showValidation = (message, title = 'Ուշադրություն') => {
        document.getElementById('validation-message').textContent = message;
        openModal(validationModal, title);
    };

    // --- Event Handlers ---
    const handleAddClick = () => {
        editingRecordId = null;
        deviceForm.reset();
        const config = DEVICE_CONFIG[currentTab];
        renderFormFields(config);
        formModalTitle.textContent = `Ավելացնել նոր ${config.title} գրառում`;
        formSubmitButton.textContent = 'Կատարել';
        openModal(formModal);
    };

    const loadFormWithRecord = (record, isDuplicate) => {
        const config = DEVICE_CONFIG[currentTab];
        renderFormFields(config);
        
        // Reset the form and ID input first
        deviceForm.reset();
        document.getElementById('record-id').value = '';

        for (const key in record) {
            const formElement = deviceForm.elements[key];
            if (formElement) {
                formElement.value = record[key] || '';
            }
        }

        if (!isDuplicate) {
            // For editing, set the actual ID
            document.getElementById('record-id').value = record.id;
            editingRecordId = record.id;
            formModalTitle.textContent = `Խմբագրել ${config.title} գրառումը`;
            formSubmitButton.textContent = 'Թարմացնել';
        } else {
            // For duplicating, keep editingRecordId as null (new record)
            editingRecordId = null;
            formModalTitle.textContent = `Կրկնօրինակել ${config.title} գրառումը`;
            formSubmitButton.textContent = 'Կրկնօրինակել';
        }

        openModal(formModal);
    };

    const handleEditClick = (id) => {
        const currentRecords = allRecords[currentTab];
        const record = currentRecords.find(r => r.id === id);
        if (record) {
            loadFormWithRecord(record, false);
        }
    };
    
    const handleDuplicateClick = (id) => {
        const currentRecords = allRecords[currentTab];
        const record = currentRecords.find(r => r.id === id);
        if (record) {
            // Create a copy of the record without the ID for duplication
            const { id: recordId, ...recordData } = record;
            loadFormWithRecord(recordData, true);
        }
    };

    const handleDeleteRequest = (id) => {
        deletingRecordId = id;
        deletePasswordInput.value = ''; // Clear previous input
        confirmDeleteButton.disabled = true;
        openModal(confirmationModal);
    };

    const handleDeleteConfirm = () => {
        if (deletePasswordInput.value === DELETE_PASSWORD) {
            allRecords[currentTab] = allRecords[currentTab].filter(record => record.id !== deletingRecordId);
            deletingRecordId = null;
            saveRecords(currentTab);
            renderTable();
            closeModal(confirmationModal);
        } else {
            showValidation('Սխալ գաղտնաբառ։ Խնդրում ենք փորձել նորից։');
            deletePasswordInput.value = '';
            confirmDeleteButton.disabled = true;
        }
    };

    const handleDeleteAllRequest = () => {
        if (allRecords[currentTab].length > 0) {
            deleteAllPasswordInput.value = ''; // Clear previous input
            confirmAllDeleteButton.disabled = true;
            openModal(deleteAllConfirmationModal);
        } else {
            showValidation('Ջնջելու համար գրառումներ չկան:', 'Տեղեկատվություն');
        }
    };

    const handleDeleteAllConfirm = () => {
        if (deleteAllPasswordInput.value === DELETE_PASSWORD) {
            allRecords[currentTab] = [];
            currentPage = 1;
            saveRecords(currentTab);
            renderTable();
            closeModal(deleteAllConfirmationModal);
            showValidation(`Բոլոր ${DEVICE_CONFIG[currentTab].title} գրառումները հաջողությամբ ջնջվեցին։`, 'Հաջողություն');
        } else {
            showValidation('Սխալ գաղտնաբառ։ Խնդրում ենք փորձել նորից։');
            deleteAllPasswordInput.value = '';
            confirmAllDeleteButton.disabled = true;
        }
    };

    const handleFormSubmit = (e) => {
        e.preventDefault();
        const formData = new FormData(deviceForm);
        const recordData = Object.fromEntries(formData.entries());
        
        const config = DEVICE_CONFIG[currentTab];
        const requiredFields = config.fields.filter(f => f.required).map(f => f.id);
        
        // Check for empty required fields
        const hasEmptyField = requiredFields.some(field => !recordData[field] || !recordData[field].trim());

        if (hasEmptyField) {
            showValidation('Խնդրում ենք լրացնել բոլոր պարտադիր դաշտերը (*):');
            return;
        }

        if (editingRecordId) {
            const index = allRecords[currentTab].findIndex(r => r.id === editingRecordId);
            if (index > -1) {
                // Keep the old ID, update other fields
                allRecords[currentTab][index] = { ...allRecords[currentTab][index], ...recordData, id: allRecords[currentTab][index].id };
            }
        } else {
            // New record (Add or Duplicate)
            const newRecord = { id: crypto.randomUUID(), ...recordData };
            allRecords[currentTab].unshift(newRecord); // Add to the beginning
            currentPage = 1; // Go to first page to see the new record
        }
        
        editingRecordId = null;
        saveRecords(currentTab);
        renderTable();
        closeModal(formModal);
    };

    // --- Export/Import Logic ---

    const escapeCsv = (str) => {
        if (!str) return '';
        str = String(str).replace(/"/g, '""');
        if (str.includes(',') || str.includes('\n') || str.includes('"')) {
            return `"${str}"`;
        }
        return str;
    };

    const handleExport = () => {
        const config = DEVICE_CONFIG[currentTab];
        const records = allRecords[currentTab];

        if (records.length === 0) {
            showValidation('Արտահանելու համար գրառումներ չկան:', 'Տեղեկատվություն');
            return;
        }

        const headers = config.fields.map(f => f.id);
        
        let csv = headers.map(escapeCsv).join(',') + '\n'; // Header row
        
        records.forEach(record => {
            const row = headers.map(header => {
                return escapeCsv(record[header] || '');
            }).join(',');
            csv += row + '\n';
        });

        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        const url = URL.createObjectURL(blob);
        
        link.setAttribute("href", url);
        link.setAttribute("download", `${currentTab}_list_${new Date().toISOString().slice(0, 10)}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showValidation(`**${currentTab}** բաժնի տվյալները հաջողությամբ արտահանվեցին:`, 'Export Հաջողություն');
    };

    const handleImport = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            const text = event.target.result;
            processImportCsv(text);
        };
        reader.onerror = () => {
            showValidation('Ֆայլը կարդալիս սխալ տեղի ունեցավ:', 'Import Սխալ');
        };
        reader.readAsText(file);
        // Reset file input to allow re-importing the same file
        e.target.value = null; 
    };

    const processImportCsv = (csvText) => {
        const config = DEVICE_CONFIG[currentTab];
        const requiredHeaders = config.fields.map(f => f.id);
        let lines = csvText.trim().split('\n');
        
        if (lines.length === 0) {
            showValidation('CSV ֆայլը դատարկ է:', 'Import Սխալ');
            return;
        }
        
        // Simple header parsing (assuming first line is header)
        const headerLine = lines.shift().trim();
        const headers = headerLine.split(',').map(h => h.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));

        // Check if required headers exist
        const missingHeaders = requiredHeaders.filter(req => !headers.includes(req));
        if (missingHeaders.length > 0) {
            showValidation(`CSV ֆայլի վերնագրերը սխալ են: Բացակայում են պարտադիր դաշտերը՝ ${missingHeaders.join(', ')}։`, 'Import Սխալ');
            return;
        }
        
        const newRecords = [];
        let importedCount = 0;

        // Simple row parsing
        lines.forEach(line => {
            if (!line.trim()) return;

            // Simple splitting by comma (does not handle quoted commas properly, but fine for basic data)
            // A more robust CSV parser would be needed for complex cases.
            const values = line.split(',').map(v => v.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
            
            const record = {};
            let isValid = true;

            requiredHeaders.forEach(reqHeader => {
                const headerIndex = headers.indexOf(reqHeader);
                if (headerIndex === -1 || !values[headerIndex] || !values[headerIndex].trim()) {
                    // Skip invalid records for simplicity
                    isValid = false;
                }
            });

            if (isValid) {
                // Map values to record object based on header position
                headers.forEach((header, index) => {
                    if (requiredHeaders.includes(header)) {
                         record[header] = values[index];
                    }
                });
                
                // Add unique ID and push
                newRecords.push({ id: crypto.randomUUID(), ...record });
                importedCount++;
            }
        });

        if (newRecords.length > 0) {
            allRecords[currentTab].unshift(...newRecords);
            saveRecords(currentTab);
            currentPage = 1;
            renderTable();
            showValidation(`**${currentTab}** բաժին ավելացվեց **${importedCount}** գրառում։`, 'Import Հաջողություն');
        } else {
            showValidation('Ներմուծվող ֆայլում չկան վավեր գրառումներ:', 'Import Սխալ');
        }
    };


    // --- Event Listeners ---
    addButton.addEventListener('click', handleAddClick);
    deleteAllButton.addEventListener('click', handleDeleteAllRequest);
    
    searchInput.addEventListener('input', () => {
        currentPage = 1;
        renderTable();
    });
    
    deviceForm.addEventListener('submit', handleFormSubmit);

    // Tab Listeners
    tabButtons.forEach(button => {
        button.addEventListener('click', (e) => switchTab(e.target.dataset.tab));
    });

    // Pagination Listeners
    prevPageButton.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    });

    nextPageButton.addEventListener('click', () => {
        const totalRecords = getFilteredRecords().length;
        const totalPages = Math.ceil(totalRecords / recordsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderTable();
        }
    });

    // Modal Close Listeners
    formCancelButton.addEventListener('click', () => closeModal(formModal));
    confirmCancelButton.addEventListener('click', () => closeModal(confirmationModal));
    confirmDeleteButton.addEventListener('click', handleDeleteConfirm);
    validationCloseButton.addEventListener('click', () => closeModal(validationModal));
    confirmAllCancelButton.addEventListener('click', () => closeModal(deleteAllConfirmationModal));
    confirmAllDeleteButton.addEventListener('click', handleDeleteAllConfirm);

    // Export/Import Listeners
    exportButton.addEventListener('click', handleExport);
    importFileInput.addEventListener('change', handleImport);

    // Password input listeners for enabling/disabling Delete buttons
    deletePasswordInput.addEventListener('input', () => {
        confirmDeleteButton.disabled = deletePasswordInput.value !== DELETE_PASSWORD;
    });
    deleteAllPasswordInput.addEventListener('input', () => {
        confirmAllDeleteButton.disabled = deleteAllPasswordInput.value !== DELETE_PASSWORD;
    });

    // Delegate events for action buttons in the table
    tableBody.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-action]');
        if (button) {
            const action = button.dataset.action;
            const row = button.closest('tr');
            const id = row.dataset.id;
            if (id) {
                if (action === 'edit') handleEditClick(id);
                if (action === 'delete') handleDeleteRequest(id);
                if (action === 'duplicate') handleDuplicateClick(id);
            }
        }
    });

    // --- Initialization ---
    loadRecords();
    switchTab(currentTab); // Initial render will happen here
});
</script>

</body>
</html>
