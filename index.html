<!DOCTYPE html>
<html lang="hy">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Device List Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              'primary': '#1a202c',
              'secondary': '#2d3748',
              'accent': '#4a5568',
              'highlight': '#38b2ac',
              'text-primary': '#e2e8f0',
              'text-secondary': '#a0aec0',
            },
          },
        },
      }
    </script>
    <style>
        /* Custom scrollbar for webkit browsers */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #2d3748; /* secondary color */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: #4a5568; /* accent color */
            border-radius: 4px;
            border: 2px solid #2d3748; /* secondary color */
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background-color: #38b2ac; /* highlight color */
        }
        /* For Firefox */
        .custom-scrollbar {
            scrollbar-width: thin;
            scrollbar-color: #4a5568 #2d3748;
        }
        /* Disabled button styles */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: scale(1);
        }
    </style>
</head>
<body class="bg-primary text-text-primary font-sans">
    
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="mb-6">
            <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
                <h1 class="text-2xl sm:text-3xl lg:text-4xl font-bold text-text-primary">Device List Manager
                </h1>
                <div class="w-full sm:w-auto flex flex-col sm:flex-row items-center gap-4">
                    <div class="relative w-full sm:w-64">
                        <input
                          id="search-input"
                          type="text"
                          placeholder="Որոնել..."
                          class="w-full bg-secondary border border-accent rounded-lg py-2 pl-10 pr-4 focus:outline-none focus:ring-2 focus:ring-highlight text-text-primary placeholder-text-secondary"
                        />
                        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="h-5 w-5 text-text-secondary"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                        </div>
                    </div>
                    <button id="add-button" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-highlight hover:bg-teal-500 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg>
                        <span>Ավելացնել</span>
                    </button>
                    <button id="import-button" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 16.5V9.75m0 0l-3.75 3.75M12 9.75l3.75 3.75M3 17.25V6.75A2.25 2.25 0 015.25 4.5h13.5A2.25 2.25 0 0121 6.75v10.5A2.25 2.25 0 0118.75 19.5H5.25A2.25 2.25 0 013 17.25z"></path></svg>
                        <span>Ներմուծել CSV</span>
                    </button>
                    <input type="file" id="import-file-input" class="hidden" accept=".csv, text/csv">
                    <button id="export-button" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3"></path></svg>
                        <span>Արտահանել CSV</span>
                    </button>
                    <button id="delete-all-button" class="w-full sm:w-auto flex items-center justify-center gap-2 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300 ease-in-out transform hover:scale-105">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.124-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.077-2.09.921-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"></path></svg>
                        <span>Ջնջել բոլորը</span>
                    </button>
                </div>
            </div>
        </header>

        <main>
            <div id="no-records-message" class="hidden text-center py-16 bg-secondary rounded-lg">
                <h2 class="text-xl text-text-secondary">Գրառումներ չկան</h2>
                <p class="mt-2 text-text-secondary">Սեղմեք «Ավելացնել» նոր IP հասցե ավելացնելու համար:</p>
            </div>
            <div id="table-container" class="bg-secondary shadow-lg rounded-lg overflow-hidden">
                <div class="overflow-x-auto custom-scrollbar">
                    <table class="min-w-full leading-normal">
                        <thead>
                            <tr class="border-b-2 border-accent bg-accent text-left text-xs font-semibold text-text-secondary uppercase tracking-wider">
                                <th class="px-5 py-3">No.</th>
                                <th class="px-5 py-3">Department</th>
                                <th class="px-5 py-3">Vlan</th>
                                <th class="px-5 py-3">Subnet Mask</th>
                                <th class="px-5 py-3">Default Gateway</th>
                                <th class="px-5 py-3">Usable IP addresses</th>
                                <th class="px-5 py-3">Network Address</th>
                                <th class="px-5 py-3">Broadcast Address</th>
                                <th class="px-5 py-3">Նշումներ</th>
                                <th class="px-5 py-3 text-center">Գործողություն</th>
                            </tr>
                        </thead>
                        <tbody id="ip-table-body">
                            </tbody>
                    </table>
                </div>
            </div>
        </main>
        
        <footer id="pagination-container" class="hidden mt-6 flex justify-center items-center gap-4">
            <button id="prev-page-button" class="py-2 px-4 bg-accent hover:bg-gray-600 text-text-primary font-semibold rounded-lg transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                Նախորդ
            </button>
            <span id="page-info" class="text-text-secondary font-medium"></span>
            <button id="next-page-button" class="py-2 px-4 bg-accent hover:bg-gray-600 text-text-primary font-semibold rounded-lg transition-colors duration-300 disabled:opacity-50 disabled:cursor-not-allowed">
                Հաջորդ
            </button>
        </footer>

    </div>

    <div id="form-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div class="bg-secondary rounded-lg shadow-xl w-full max-w-lg max-h-full overflow-y-auto custom-scrollbar">
            <div class="p-6">
                <h2 id="form-modal-title" class="text-2xl font-bold mb-6 text-text-primary"></h2>
                <form id="ip-form" class="space-y-4">
                    <input type="hidden" id="record-id" name="id">
                    <div>
                        <label for="department" class="block text-sm font-medium text-text-secondary mb-1">Department</label>
                        <input type="text" id="department" name="department" class="w-full bg-primary border border-accent rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-highlight text-text-primary">
                    </div>
                    <div>
                        <label for="vlan" class="block text-sm font-medium text-text-secondary mb-1">Vlan</label>
                        <input type="text" id="vlan" name="vlan" class="w-full bg-primary border border-accent rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-highlight text-text-primary">
                    </div>
                    <div>
                        <label for="subnetMask" class="block text-sm font-medium text-text-secondary mb-1">SubNet MASK</label>
                        <input type="text" id="subnetMask" name="subnetMask" class="w-full bg-primary border border-accent rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-highlight text-text-primary">
                    </div>
                    <div>
                        <label for="defaultGateway" class="block text-sm font-medium text-text-secondary mb-1">Default Gateway</label>
                        <input type="text" id="defaultGateway" name="defaultGateway" class="w-full bg-primary border border-accent rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-highlight text-text-primary">
                    </div>
                    <div>
                        <label for="usableIPs" class="block text-sm font-medium text-text-secondary mb-1">Usable IP addresses</label>
                        <input type="text" id="usableIPs" name="usableIPs" class="w-full bg-primary border border-accent rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-highlight text-text-primary">
                    </div>
                    <div>
                        <label for="networkAddress" class="block text-sm font-medium text-text-secondary mb-1">Network Address</label>
                        <input type="text" id="networkAddress" name="networkAddress" class="w-full bg-primary border border-accent rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-highlight text-text-primary">
                    </div>
                    <div>
                        <label for="broadcastAddress" class="block text-sm font-medium text-text-secondary mb-1">Broadcast Address</label>
                        <input type="text" id="broadcastAddress" name="broadcastAddress" class="w-full bg-primary border border-accent rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-highlight text-text-primary">
                    </div>
                    <div>
                        <label for="notes" class="block text-sm font-medium text-text-secondary mb-1">Նշումներ</label>
                        <textarea id="notes" name="notes" rows="3" class="w-full bg-primary border border-accent rounded-md p-2 focus:outline-none focus:ring-2 focus:ring-highlight text-text-primary"></textarea>
                    </div>
                    <div class="flex justify-end gap-4 pt-6">
                        <button type="button" id="form-cancel-button" class="py-2 px-4 bg-accent hover:bg-gray-600 text-text-primary font-semibold rounded-lg transition-colors duration-300">Չեղարկել</button>
                        <button type="submit" id="form-submit-button" class="py-2 px-4 bg-highlight hover:bg-teal-500 text-white font-semibold rounded-lg transition-colors duration-300"></button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div class="bg-secondary rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6">
                <h2 class="text-xl font-bold mb-4 text-text-primary">Հաստատում</h2>
                <p class="text-text-secondary mb-6">Վստա՞հ եք, որ ցանկանում եք ջնջել:</p>
                <div class="flex justify-end gap-4">
                    <button id="confirm-cancel-button" class="py-2 px-4 bg-accent hover:bg-gray-600 text-text-primary font-semibold rounded-lg transition-colors duration-300">Չեղարկել</button>
                    <button id="confirm-delete-button" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors duration-300">Ջնջել</button>
                </div>
            </div>
        </div>
    </div>

    <div id="delete-all-confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div class="bg-secondary rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6">
                <h2 class="text-xl font-bold mb-4 text-text-primary">Հաստատում</h2>
                <p class="text-text-secondary mb-6">Վստա՞հ եք, որ ցանկանում եք ջնջել բոլոր գրառումները: Այս գործողությունը չեղարկել հնարավոր չէ:</p>
                <div class="flex justify-end gap-4">
                    <button id="confirm-all-cancel-button" class="py-2 px-4 bg-accent hover:bg-gray-600 text-text-primary font-semibold rounded-lg transition-colors duration-300">Չեղարկել</button>
                    <button id="confirm-all-delete-button" class="py-2 px-4 bg-red-600 hover:bg-red-700 text-white font-semibold rounded-lg transition-colors duration-300">Այո, ջնջել</button>
                </div>
            </div>
        </div>
    </div>

    <div id="validation-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div class="bg-secondary rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6 text-center">
                <h2 class="text-xl font-bold mb-4 text-text-primary">Ուշադրություն</h2>
                <p class="text-text-secondary mb-6">Խնդրում ենք լրացնել բոլոր դատարկ դաշտերը:</p>
                <div class="flex justify-center gap-4">
                    <button id="validation-close-button" class="py-2 px-6 bg-highlight hover:bg-teal-500 text-white font-semibold rounded-lg transition-colors duration-300">Փակել</button>
                </div>
            </div>
        </div>
    </div>

    <div id="import-success-modal" class="hidden fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
        <div class="bg-secondary rounded-lg shadow-xl w-full max-w-sm">
            <div class="p-6 text-center">
                <h2 class="text-xl font-bold mb-4 text-text-primary">Հաջողված ներմուծում</h2>
                <p id="import-success-message" class="text-text-secondary mb-6"></p>
                <div class="flex justify-center gap-4">
                    <button id="import-success-close-button" class="py-2 px-6 bg-highlight hover:bg-teal-500 text-white font-semibold rounded-lg transition-colors duration-300">Փակել</button>
                </div>
            </div>
        </div>
    </div>

    <div id="copy-toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-highlight text-white px-4 py-2 rounded-lg shadow-lg opacity-0 transform translate-y-4 transition-all duration-300 ease-in-out z-50 pointer-events-none">
        Պատճենվել է!
    </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // State
    let ipRecords = [];
    let editingRecordId = null;
    let deletingRecordId = null;
    let copyToastTimeout = null;
    let currentPage = 1;
    const recordsPerPage = 10;

    // DOM Elements
    const tableBody = document.getElementById('ip-table-body');
    const noRecordsMessage = document.getElementById('no-records-message');
    const tableContainer = document.getElementById('table-container');
    const searchInput = document.getElementById('search-input');
    const copyToast = document.getElementById('copy-toast');
    
    // Pagination Elements
    const paginationContainer = document.getElementById('pagination-container');
    const prevPageButton = document.getElementById('prev-page-button');
    const nextPageButton = document.getElementById('next-page-button');
    const pageInfo = document.getElementById('page-info');

    // Modals
    const formModal = document.getElementById('form-modal');
    const confirmationModal = document.getElementById('confirmation-modal');
    const validationModal = document.getElementById('validation-modal');
    const deleteAllConfirmationModal = document.getElementById('delete-all-confirmation-modal');
    const importSuccessModal = document.getElementById('import-success-modal');
    const importSuccessMessage = document.getElementById('import-success-message');

    // Form Elements
    const ipForm = document.getElementById('ip-form');
    const formModalTitle = document.getElementById('form-modal-title');
    const formSubmitButton = document.getElementById('form-submit-button');
    const importFileInput = document.getElementById('import-file-input');

    // Buttons
    const addButton = document.getElementById('add-button');
    const deleteAllButton = document.getElementById('delete-all-button');
    const importButton = document.getElementById('import-button');
    const exportButton = document.getElementById('export-button');
    const formCancelButton = document.getElementById('form-cancel-button');
    const confirmCancelButton = document.getElementById('confirm-cancel-button');
    const confirmDeleteButton = document.getElementById('confirm-delete-button');
    const validationCloseButton = document.getElementById('validation-close-button');
    const confirmAllCancelButton = document.getElementById('confirm-all-cancel-button');
    const confirmAllDeleteButton = document.getElementById('confirm-all-delete-button');
    const importSuccessCloseButton = document.getElementById('import-success-close-button');


    // --- Data Persistence ---
    const loadRecords = () => {
        try {
            const savedRecords = localStorage.getItem('ipRecords');
            let records = savedRecords ? JSON.parse(savedRecords) : [];
            
            let madeChanges = false;
            records.forEach(record => {
                if (!record.id) {
                    record.id = crypto.randomUUID(); 
                    madeChanges = true;
                }
            });

            ipRecords = records;

            if (madeChanges) {
                saveRecords();
            }
        } catch (error) {
            console.error("Failed to parse IP records from localStorage", error);
            ipRecords = [];
        }
    };

    const saveRecords = () => {
        try {
            localStorage.setItem('ipRecords', JSON.stringify(ipRecords));
        } catch (error) {
            console.error("Failed to save IP records to localStorage", error);
        }
    };
    
    // --- Pagination ---
    const renderPagination = (totalRecords) => {
        const totalPages = Math.ceil(totalRecords / recordsPerPage);

        if (totalPages <= 1) {
            paginationContainer.classList.add('hidden');
            return;
        }

        paginationContainer.classList.remove('hidden');
        pageInfo.textContent = `Էջ ${currentPage} / ${totalPages}`;
        prevPageButton.disabled = currentPage === 1;
        nextPageButton.disabled = currentPage === totalPages;
    };


    // --- Rendering ---
    const renderTable = () => {
        const hasRecords = ipRecords.length > 0;
        deleteAllButton.disabled = !hasRecords;
        exportButton.disabled = !hasRecords;

        const searchTerm = searchInput.value.toLowerCase();
        const filteredRecords = ipRecords.filter(record =>
            [
                record.department,
                record.vlan,
                record.subnetMask,
                record.defaultGateway,
                record.usableIPs,
                record.networkAddress,
                record.broadcastAddress,
                record.notes
            ].some(value => value && String(value).toLowerCase().includes(searchTerm))
        );

        const totalRecords = filteredRecords.length;
        const totalPages = Math.ceil(totalRecords / recordsPerPage);
        
        // Adjust current page if it's out of bounds after filtering/deletion
        if (currentPage > totalPages) {
            currentPage = totalPages || 1;
        }

        const startIndex = (currentPage - 1) * recordsPerPage;
        const endIndex = startIndex + recordsPerPage;
        const paginatedRecords = filteredRecords.slice(startIndex, endIndex);

        tableBody.innerHTML = '';

        if (totalRecords === 0) {
            noRecordsMessage.classList.remove('hidden');
            tableContainer.classList.add('hidden');
        } else {
            noRecordsMessage.classList.add('hidden');
            tableContainer.classList.remove('hidden');
            paginatedRecords.forEach((record, index) => {
                const globalIndex = startIndex + index;
                const row = document.createElement('tr');
                row.className = 'border-b border-accent hover:bg-accent/50 transition-colors duration-200';
                row.dataset.id = record.id;

                const createCopyableCell = (text) => {
                    const cell = document.createElement('td');
                    cell.className = 'px-5 py-4 text-sm';

                    const container = document.createElement('div');
                    container.className = 'flex items-center gap-2 group relative';
                    
                    const textSpan = document.createElement('span');
                    textSpan.className = 'truncate';
                    textSpan.title = text;
                    textSpan.textContent = text || "-";
                    
                    const copyButton = document.createElement('button');
                    // ՇՏԿՈՒՄ 2-Բ: Ավելացվել է type="button" ատրիբուտը
                    copyButton.type = 'button'; 
                    copyButton.className = 'opacity-0 group-hover:opacity-100 text-text-secondary hover:text-highlight transition-all duration-200 focus:outline-none';
                    copyButton.title = 'Պատճենել';
                    copyButton.disabled = !text;
                    copyButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="h-4 w-4"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>`;
                    
                    // ՇՏԿՈՒՄ 2-Գ: Ավելացվել է e.stopPropagation()՝ կանխելու համար CRUD կոճակների ակտիվացումը
                    copyButton.onclick = (e) => {
                        e.stopPropagation(); 
                        navigator.clipboard.writeText(text).then(() => {
                            if (copyToastTimeout) {
                                clearTimeout(copyToastTimeout);
                            }
                            copyToast.classList.remove('opacity-0', 'translate-y-4');
                            copyToast.classList.add('opacity-100', 'translate-y-0');
                            copyToastTimeout = setTimeout(() => {
                                copyToast.classList.remove('opacity-100', 'translate-y-0');
                                copyToast.classList.add('opacity-0', 'translate-y-4');
                                copyToastTimeout = null;
                            }, 2000);
                        }).catch(err => console.error("Failed to copy text: ", err));
                    };

                    container.appendChild(textSpan);
                    container.appendChild(copyButton);
                    cell.appendChild(container);
                    return cell;
                };
                
                row.innerHTML = `<td class="px-5 py-4 text-sm">${globalIndex + 1}</td>`;
                row.appendChild(createCopyableCell(record.department));
                row.appendChild(createCopyableCell(record.vlan));
                row.appendChild(createCopyableCell(record.subnetMask));
                row.appendChild(createCopyableCell(record.defaultGateway));
                row.appendChild(createCopyableCell(record.usableIPs));
                row.appendChild(createCopyableCell(record.networkAddress));
                row.appendChild(createCopyableCell(record.broadcastAddress));
                
                const notesCell = document.createElement('td');
                notesCell.className = 'px-5 py-4 text-sm max-w-xs truncate';
                notesCell.title = record.notes;
                notesCell.textContent = record.notes;
                row.appendChild(notesCell);

                const actionsCell = document.createElement('td');
                actionsCell.className = 'px-5 py-4 text-sm text-center';
                // ՇՏԿՈՒՄ 2-Ա: Ավելացվել է type="button" ատրիբուտը CRUD կոճակներին
                actionsCell.innerHTML = `
                    <div class="flex items-center justify-center gap-4">
                        <button type="button" data-action="duplicate" class="text-green-400 hover:text-green-300 transition-colors duration-200" title="Կրկնօրինակել">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 17.25v3.375c0 .621-.504 1.125-1.125 1.125h-9.75a1.125 1.125 0 01-1.125-1.125V7.875c0-.621.504-1.125 1.125-1.125H6.75a9.06 9.06 0 011.5.124m7.5 10.376h3.375c.621 0 1.125-.504 1.125-1.125V11.25c0-4.46-3.243-8.161-7.5-8.876a9.06 9.06 0 00-1.5-.124H9.375c-.621 0-1.125.504-1.125 1.125v3.5m7.5 10.375H9.375a1.125 1.125 0 01-1.125-1.125v-9.25m12 6.625v-1.875a3.375 3.375 0 00-3.375-3.375h-1.5a1.125 1.125 0 01-1.125-1.125v-1.5a3.375 3.375 0 00-3.375-3.375H9.75"></path></svg>
                        </button>
                        <button type="button" data-action="edit" class="text-blue-400 hover:text-blue-300 transition-colors duration-200" title="Խմբագրել">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.5L15.232 5.232z"></path></svg>
                        </button>
                        <button type="button" data-action="delete" class="text-red-400 hover:text-red-300 transition-colors duration-200" title="Ջնջել">
                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" class="h-5 w-5"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>`;
                row.appendChild(actionsCell);
                tableBody.appendChild(row);
            });
        }
        renderPagination(totalRecords);
    };

    // ... (մնացած JavaScript կոդը մնում է անփոփոխ, քանի որ CRUD-ի տրամաբանությունը ճիշտ է) ...
    // --- Modal Control ---
    const openModal = (modal) => modal.classList.remove('hidden');
    const closeModal = (modal) => modal.classList.add('hidden');

    // --- Event Handlers ---
    const handleAddClick = () => {
        editingRecordId = null;
        ipForm.reset();
        formModalTitle.textContent = 'Ավելացնել նոր IP գրառում';
        formSubmitButton.textContent = 'Կատարել';
        openModal(formModal);
    };

    const handleEditClick = (id) => {
        const record = ipRecords.find(r => r.id === id);
        if (record) {
            editingRecordId = id;
            for (const key in record) {
                if (ipForm.elements[key]) {
                    ipForm.elements[key].value = record[key];
                }
            }
            formModalTitle.textContent = 'Խմբագրել IP գրառումը';
            formSubmitButton.textContent = 'Թարմացնել';
            openModal(formModal);
        }
    };
    
    const handleDuplicateClick = (id) => {
        const record = ipRecords.find(r => r.id === id);
        if (record) {
            editingRecordId = null; // Important: we're creating a new record
            const { id: recordId, ...recordData } = record;
            for (const key in recordData) {
                if (ipForm.elements[key]) {
                    ipForm.elements[key].value = recordData[key];
                }
            }
            formModalTitle.textContent = 'Կրկնօրինակել IP գրառումը';
            formSubmitButton.textContent = 'Կրկնօրինակել';
            openModal(formModal);
        }
    };

    const handleDeleteRequest = (id) => {
        deletingRecordId = id;
        openModal(confirmationModal);
    };

    const handleDeleteConfirm = () => {
        ipRecords = ipRecords.filter(record => record.id !== deletingRecordId);
        deletingRecordId = null;
        saveRecords();
        renderTable();
        closeModal(confirmationModal);
    };

    const handleDeleteAllRequest = () => {
        if (ipRecords.length > 0) {
            openModal(deleteAllConfirmationModal);
        }
    };

    const handleDeleteAllConfirm = () => {
        ipRecords = [];
        currentPage = 1;
        saveRecords();
        renderTable();
        closeModal(deleteAllConfirmationModal);
    };

    const handleFormSubmit = (e) => {
        e.preventDefault();
        const formData = new FormData(ipForm);
        const recordData = Object.fromEntries(formData.entries());

        const requiredFields = ['department', 'vlan', 'subnetMask', 'defaultGateway', 'usableIPs', 'networkAddress', 'broadcastAddress'];
        const hasEmptyField = requiredFields.some(field => !recordData[field] || !recordData[field].trim());

        if (hasEmptyField) {
            openModal(validationModal);
            return;
        }

        if (editingRecordId) {
            const index = ipRecords.findIndex(r => r.id === editingRecordId);
            if (index > -1) {
                ipRecords[index] = { ...ipRecords[index], ...recordData };
            }
        } else {
            const newRecord = { id: crypto.randomUUID(), ...recordData };
            ipRecords.unshift(newRecord); // Add to the beginning
            currentPage = 1; // Go to first page to see the new record
        }
        
        editingRecordId = null;
        saveRecords();
        renderTable();
        closeModal(formModal);
    };

    const escapeCSV = (str) => {
        if (str === null || str === undefined) {
            return '';
        }
        let result = String(str);
        if (result.includes(',') || result.includes('"') || result.includes('\n')) {
            result = result.replace(/"/g, '""'); // Escape double quotes
            result = `"${result}"`; // Enclose in double quotes
        }
        return result;
    };

    const handleExportClick = () => {
        if (ipRecords.length === 0) {
            alert('No records to export.');
            return;
        }
        const headers = ['No.', 'Department', 'Vlan', 'Subnet Mask', 'Default Gateway', 'Usable IP addresses', 'Network Address', 'Broadcast Address', 'Նշումներ'];
        const rows = ipRecords.map((record, index) => [
            index + 1, record.department, record.vlan, record.subnetMask, record.defaultGateway,
            record.usableIPs, record.networkAddress, record.broadcastAddress, record.notes
        ].map(escapeCSV));

        const csvContent = [headers.join(','), ...rows.map(row => row.join(','))].join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        const date = new Date().toISOString().slice(0, 10);
        link.setAttribute('href', url);
        link.setAttribute('download', `ip_records_${date}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
    };

    const handleImportClick = () => {
        importFileInput.click();
    };

    const handleFileSelect = (event) => {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
            let csvText = e.target.result;
            try {
                if (csvText.startsWith('\uFEFF')) { // Handle BOM
                    csvText = csvText.substring(1);
                }
                const lines = csvText.trim().split(/\r?\n/);
                if (lines.length < 2) {
                    alert('File is empty or contains only a header.');
                    return;
                }
                
                const headerLine = lines.shift().trim();
                const fileHeaders = [];
                const headerRegex = /(?:"([^"]*(?:""[^"]*)*)"|([^,]*))(?:,|$)/g;
                let headerMatch;
                while (headerMatch = headerRegex.exec(headerLine)) {
                    fileHeaders.push(headerMatch[1] ? headerMatch[1].replace(/""/g, '"') : headerMatch[2]);
                    if (!headerMatch[0].endsWith(',')) break;
                }

                const keyMap = {
                    'Department': 'department', 'Vlan': 'vlan', 'Subnet Mask': 'subnetMask',
                    'Default Gateway': 'defaultGateway', 'Usable IP addresses': 'usableIPs',
                    'Network Address': 'networkAddress', 'Broadcast Address': 'broadcastAddress', 'Նշումներ': 'notes'
                };
                
                const headerMapping = fileHeaders.map(h => keyMap[h.trim()]);

                const newRecords = lines.map(line => {
                    if (!line.trim()) return null;
                    
                    const values = [];
                    const valueRegex = /(?:"([^"]*(?:""[^"]*)*)"|([^,]*))(?:,|$)/g;
                    let valueMatch;
                    while (valueMatch = valueRegex.exec(line)) {
                         values.push(valueMatch[1] ? valueMatch[1].replace(/""/g, '"') : valueMatch[2]);
                         if (!valueMatch[0].endsWith(',')) break;
                    }
                    
                    const record = {};
                    let hasData = false;
                    headerMapping.forEach((key, index) => {
                        if (key && values[index] !== undefined && values[index].trim() !== '') {
                            record[key] = values[index];
                            hasData = true;
                        }
                    });
                    
                    if (hasData) {
                        record.id = crypto.randomUUID();
                        return record;
                    }
                    return null;
                }).filter(Boolean);

                if (newRecords.length > 0) {
                    ipRecords.push(...newRecords);
                    saveRecords();
                    renderTable();
                    importSuccessMessage.textContent = `Հաջողությամբ ներմուծվել է ${newRecords.length} գրառում։`;
                    openModal(importSuccessModal);
                } else {
                    alert('No valid records found in the file to import. Please check column headers.');
                }
            } catch (error) {
                console.error("Failed to parse CSV file:", error);
                alert("Error parsing CSV file. Please check the file format and try again.");
            } finally {
                event.target.value = null; // Reset file input
            }
        };
        reader.onerror = () => {
            alert("Error reading file.");
            event.target.value = null;
        };
        reader.readAsText(file);
    };

    // --- Event Listeners ---
    addButton.addEventListener('click', handleAddClick);
    deleteAllButton.addEventListener('click', handleDeleteAllRequest);
    exportButton.addEventListener('click', handleExportClick);
    importButton.addEventListener('click', handleImportClick);
    importFileInput.addEventListener('change', handleFileSelect);
    
    searchInput.addEventListener('input', () => {
        currentPage = 1;
        renderTable();
    });
    
    ipForm.addEventListener('submit', handleFormSubmit);

    // Pagination Listeners
    prevPageButton.addEventListener('click', () => {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
        }
    });

    nextPageButton.addEventListener('click', () => {
        const totalRecords = ipRecords.filter(r => JSON.stringify(r).toLowerCase().includes(searchInput.value.toLowerCase())).length;
        const totalPages = Math.ceil(totalRecords / recordsPerPage);
        if (currentPage < totalPages) {
            currentPage++;
            renderTable();
        }
    });

    // Modal Close Listeners
    formCancelButton.addEventListener('click', () => closeModal(formModal));
    confirmCancelButton.addEventListener('click', () => closeModal(confirmationModal));
    confirmDeleteButton.addEventListener('click', handleDeleteConfirm);
    validationCloseButton.addEventListener('click', () => closeModal(validationModal));
    importSuccessCloseButton.addEventListener('click', () => closeModal(importSuccessModal));
    confirmAllCancelButton.addEventListener('click', () => closeModal(deleteAllConfirmationModal));
    confirmAllDeleteButton.addEventListener('click', handleDeleteAllConfirm);

    // Delegate events for action buttons in the table
    // Այս հատվածը ճիշտ է և թույլ է տալիս աշխատել CRUD կոճակներին
    tableBody.addEventListener('click', (e) => {
        const button = e.target.closest('button[data-action]');
        if (button) {
            const action = button.dataset.action;
            const row = button.closest('tr');
            const id = row.dataset.id;
            if (id) {
                if (action === 'edit') handleEditClick(id);
                if (action === 'delete') handleDeleteRequest(id);
                if (action === 'duplicate') handleDuplicateClick(id);
            }
        }
    });

    // --- Initialization ---
    loadRecords();
    renderTable();
});
</script>

</body>
</html>
